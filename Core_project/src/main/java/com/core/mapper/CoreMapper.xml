<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
         "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.core.mapper.CoreMapper">

  <!-- 1. Proposal 관련 매핑 -->
  <resultMap id="ProposalResult" type="com.core.model.ProposalVO">
    <id     property="PRPSL_NO"         column="PRPSL_NO"/>
    <result property="ID"               column="ID"/>
    <result property="CATEGORY"         column="CATEGORY"/>
    <result property="TITLE"            column="TITLE"/>
    <result property="CONTENT"          column="CONTENT"/>
    <result property="EXPECTATION_EFFECT" column="EXPECTATION_EFFECT"/>
    <result property="PRPSL_DT"         column="PRPSL_DT"/>
    <result property="ST_CD"            column="ST_CD"/>
    <result property="PRCS_NM"          column="PRCS_NM"/>
    <result property="RESULT_CONTENT"   column="RESULT_CONTENT"/>
    <result property="AGREE_CNT"        column="AGREE_CNT"/>
    <result property="DISAG_CNT"        column="DISAG_CNT"/>
  </resultMap>

  <!-- 2. AI 분석 결과 매핑 -->
  <resultMap id="AiAnalysisResult" type="com.core.model.Ai_analysisVO">
    <id     property="ANALYSIS_NO"    column="ANALYSIS_NO"/>
    <result property="PRPSL_NO"       column="PRPSL_NO"/>
    <result property="ANALYSIS_MODEL" column="ANALYSIS_MODEL"/>
    <result property="ANALYSIS_RESULT" column="ANALYSIS_RESULT"/>
    <result property="SIMILARITY"     column="SIMILARITY"/>
    <result property="RECO_POLICY"    column="RECO_POLICY"/>
    <result property="ANALIZED_AT"    column="ANALIZED_AT"/>
  </resultMap>

  <!-- 3. 토론방 매핑 -->
  <resultMap id="DiscussRoomResult" type="com.core.model.Discuss_roomVO">
    <id     property="droom_no"       column="DROOM_NO" />
    <result property="droom_category" column="DROOM_CATEGORY" />
    <result property="droom_title"    column="DROOM_TITLE" />
    <result property="droom_info"     column="DROOM_INFO" />
    <result property="id"             column="ID" />
    <result property="droom_limit"    column="DROOM_LIMIT" />
    <result property="droom_mg"       column="DROOM_MG" />
<result property="create_at" column="CREATE_AT" jdbcType="TIMESTAMP" javaType="java.sql.Timestamp"/>
    <result property="droom_st"       column="DROOM_ST" />
  </resultMap>

  <!-- 회원가입 -->
  <insert id="join" parameterType="com.core.model.UserinfoVO">
    INSERT INTO Userinfo (id,pw,nick,region,id_card, is_approved, joined_at)
    VALUES (#{id},#{pw},#{nick},#{region},#{id_card},#{is_approved},#{joined_at})
  </insert>

  <!-- 로그인 -->
  <select id="login" parameterType="com.core.model.UserinfoVO" resultType="com.core.model.UserinfoVO">
    SELECT * FROM Userinfo WHERE id = #{id} AND pw = #{pw}
  </select>

  <!-- 회원탈퇴 -->
  <delete id="delete" parameterType="string">
    DELETE FROM Userinfo WHERE ID = #{value, jdbcType=VARCHAR}
  </delete>

  <!-- 정책 제안 -->
  <insert id="insertProposal" parameterType="com.core.model.ProposalVO" keyProperty="PRPSL_NO">
    INSERT INTO PROPOSAL (
      ID, CATEGORY, TITLE, CONTENT, EXPECTATION_EFFECT, PRPSL_DT,
      ST_CD, PRCS_NM, RESULT_CONTENT, AGREE_CNT, DISAG_CNT
    ) VALUES (
      #{ID, jdbcType=VARCHAR}, #{CATEGORY, jdbcType=VARCHAR}, #{TITLE, jdbcType=VARCHAR},
      #{CONTENT, jdbcType=VARCHAR}, #{EXPECTATION_EFFECT, jdbcType=VARCHAR}, #{PRPSL_DT, jdbcType=TIMESTAMP},
      #{ST_CD, jdbcType=VARCHAR}, #{PRCS_NM, jdbcType=VARCHAR}, #{RESULT_CONTENT, jdbcType=VARCHAR},
      #{AGREE_CNT, jdbcType=INTEGER}, #{DISAG_CNT, jdbcType=INTEGER}
    )
  </insert>

  <select id="selectAllProposals" resultMap="ProposalResult">
    SELECT * FROM PROPOSAL ORDER BY PRPSL_DT DESC
  </select>

  <select id="selectProposalById" parameterType="int" resultMap="ProposalResult">
    SELECT * FROM PROPOSAL WHERE PRPSL_NO = #{id}
  </select>

  <select id="selectByCategory" parameterType="string" resultMap="ProposalResult">
    SELECT * FROM PROPOSAL WHERE CATEGORY = #{category} ORDER BY PRPSL_DT DESC
  </select>

  <select id="similarSearch" parameterType="string" resultMap="AiAnalysisResult">
    SELECT * FROM AI_ANALYSIS
    WHERE ANALYSIS_RESULT LIKE '%' || #{idea} || '%'
    ORDER BY SIMILARITY DESC
  </select>

  <!-- 투표 관련 -->
  <select id="checkVote" resultType="com.core.model.ProposalVoteVO">
    SELECT PRPSL_NO AS prpslNo, USER_ID AS userId, VOTE_TYPE AS voteType
    FROM PROPOSAL_VOTE
    WHERE PRPSL_NO = #{prpslNo} AND USER_ID = #{userId}
  </select>

  <insert id="insertVote" parameterType="com.core.model.ProposalVoteVO">
    INSERT INTO PROPOSAL_VOTE (PRPSL_NO, USER_ID, VOTE_TYPE)
    VALUES (#{prpslNo}, #{userId}, #{voteType})
  </insert>

  <update id="incrementAgree">
    UPDATE PROPOSAL SET AGREE_CNT = AGREE_CNT + 1 WHERE PRPSL_NO = #{prpslNo}
  </update>

  <update id="incrementDisagree">
    UPDATE PROPOSAL SET DISAG_CNT = DISAG_CNT + 1 WHERE PRPSL_NO = #{prpslNo}
  </update>

  <!-- 🗣 토론방 쿼리들 -->
  <select id="selectAllRooms" resultMap="DiscussRoomResult">
  SELECT
    DROOM_NO,
    DROOM_CATEGORY,
    DROOM_TITLE,
    DROOM_INFO,
    ID,
    DROOM_LIMIT,
    DROOM_MG,
    CREATED_AT,
    DROOM_ST
  FROM DISCUSS_ROOM
  ORDER BY CREATED_AT DESC
</select>

  <select id="searchRoomsByTitle" parameterType="string" resultMap="DiscussRoomResult">
    SELECT * FROM DISCUSS_ROOM
    WHERE DROOM_TITLE LIKE '%' || #{keyword} || '%'
    ORDER BY CREATE_AT DESC
  </select>

  <insert id="insertDiscussRoom" parameterType="com.core.model.Discuss_roomVO" useGeneratedKeys="true" keyProperty="droom_no">
    INSERT INTO DISCUSS_ROOM (
      DROOM_CATEGORY, DROOM_TITLE, DROOM_INFO, ID,
      DROOM_LIMIT, DROOM_MG, CREATE_AT, DROOM_ST
    ) VALUES (
      #{droom_category}, #{droom_title}, #{droom_info}, #{id},
      #{droom_limit}, #{droom_mg}, #{create_at}, #{droom_st}
    )
  </insert>
  <!-- 🗣 토론방 들어가기 -->
  <select id="selectRoomById" parameterType="int" resultMap="DiscussRoomResult">
  SELECT *
  FROM DISCUSS_ROOM
  WHERE DROOM_NO = #{id}
 </select>

</mapper>
